{"version":3,"sources":["../../../../../src/shadertools/modules/fp64/fp64-test-utils.js"],"names":["Buffer","Program","assembleShaders","registerShaderModules","fp64","initializeGL","initializeTexTarget","render","getGPUOutput","BUFFER_DATA","Float32Array","fp64ify","a","hi","Math","fround","lo","getFloat64","upper","random","pow","getRelativeError64","result","reference","reference64","result64","abs","getRelativeError","getBinaryShader","operation","getUnaryShader","FS_RENDER_VCOLOR","setupFloatTest","gl","glslFunc","binary","limit","op","b","expected","a_fp64","b_fp64","expected_fp64","vs","program","fs","modules","use","setBuffers","positions","target","ARRAY_BUFFER","data","size","setUniforms","ONE","ITERATIONS","EPSILON","testcase","t","idx0","gpu_result","relativeError","args","toPrecision","message","ok","comment","toString","end","canvas","document","createElement","width","height","window","onload","body","appendChild"],"mappings":"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","sourcesContent":["// Copyright (c) 2015 - 2017 Uber Technologies, Inc.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the 'Software'), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED 'AS IS', WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\n\n// Special utility functions for df64 tests\n\n/* eslint-disable camelcase, prefer-template, max-len */\n/* global window, document, */\n\nimport {Buffer, Program, assembleShaders, registerShaderModules, fp64} from 'luma.gl';\nimport {initializeGL, initializeTexTarget, render, getGPUOutput} from '../../test/gpu-test-utils';\n\nconst BUFFER_DATA = new Float32Array([1, 1, -1, 1, 1, -1, -1, -1]);\n\nfunction fp64ify(a) {\n  const hi = Math.fround(a);\n  const lo = a - Math.fround(a);\n  return new Float32Array([hi, lo]);\n}\n\nfunction getFloat64(upper = 256) {\n  return Math.random() * Math.pow(2.0, (Math.random() - 0.5) * upper);\n}\n\nexport function getRelativeError64(result, reference) {\n  const reference64 = reference[0] + reference[1];\n  const result64 = result[0] + result[1];\n  return Math.abs((reference64 - result64) / reference64);\n}\n\nexport function getRelativeError(result, reference) {\n  return Math.abs((reference - result) / reference);\n}\n\nfunction getBinaryShader(operation) {\n  return `\\\nattribute vec3 positions;\nuniform vec2 a;\nuniform vec2 b;\nvarying vec4 vColor;\nvoid main(void) {\n  gl_Position = vec4(positions, 1.0);\n  vec2 result = ${operation}(a, b);\n  vColor = vec4(result.x, result.y, 0.0, 1.0);\n}\n`;\n}\n\nfunction getUnaryShader(operation) {\n  return `\\\nattribute vec3 positions;\nuniform vec2 a;\nvarying vec4 vColor;\nvoid main(void) {\n  gl_Position = vec4(positions, 1.0);\n  vec2 result = ${operation}(a);\n  vColor = vec4(result.x, result.y, 0.0, 1.0);\n}\n`;\n}\n\nconst FS_RENDER_VCOLOR = `\\\n#ifdef GL_ES\nprecision highp float;\n#endif\nvarying vec4 vColor;\nvoid main(void) {\n  gl_FragColor = vColor;\n}\n`;\n\nfunction setupFloatTest(gl, {glslFunc, binary = false, limit = 256, op}) {\n  const a = getFloat64(limit);\n  const b = getFloat64(limit);\n  const expected = op(a, b);\n\n  const a_fp64 = fp64ify(a);\n  const b_fp64 = fp64ify(b);\n  const expected_fp64 = fp64ify(expected);\n\n  const vs = binary ? getBinaryShader(glslFunc) : getUnaryShader(glslFunc);\n\n  const program = new Program(gl, assembleShaders(gl, {\n    vs,\n    fs: FS_RENDER_VCOLOR,\n    modules: ['fp64']\n  }));\n\n  program\n    .use()\n    .setBuffers({\n      positions: new Buffer(gl, {target: gl.ARRAY_BUFFER, data: BUFFER_DATA, size: 2})\n    })\n    .setUniforms({\n      a: a_fp64,\n      b: b_fp64,\n      ONE: 1.0\n    });\n\n  return {a, b, expected, a_fp64, b_fp64, expected_fp64, program};\n}\n\nconst ITERATIONS = 10;\nconst EPSILON = 1e-14;\n\nexport function testcase(gl, {glslFunc, binary, op, limit = 256, t}) {\n  for (let idx0 = 0; idx0 < ITERATIONS; idx0++) {\n    const {a, b, a_fp64, b_fp64, expected_fp64} = setupFloatTest(gl, {\n      glslFunc, binary, op, limit\n    });\n    render(gl);\n    const gpu_result = getGPUOutput(gl);\n    const relativeError = getRelativeError64(gpu_result, expected_fp64);\n    const args = binary ? `(${a.toPrecision(2)}, ${b.toPrecision(2)})` : `(${a.toPrecision(2)})`;\n    const message = `${glslFunc}${args}: error=${relativeError}, within ${EPSILON}`;\n    t.ok(relativeError < EPSILON, message);\n    if (relativeError >= EPSILON) {\n      t.comment(` (tested ${a_fp64.toString()}, ${b_fp64.toString()})`);\n    }\n  }\n  t.end();\n}\n\n// Main entrance\nconst canvas = document.createElement('canvas');\ncanvas.width = 16;\ncanvas.height = 16;\n\nexport const gl = initializeGL(canvas);\ninitializeTexTarget(gl);\nregisterShaderModules([fp64]);\n\nwindow.onload = () => {\n  document.body.appendChild(canvas);\n};\n"],"file":"fp64-test-utils.js"}