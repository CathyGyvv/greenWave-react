{"version":3,"sources":["../../../../src/shadertools/lib/shader-cache.js"],"names":["VertexShader","FragmentShader","Program","assert","ShaderCache","constructor","gl","_cachePrograms","vertexShaders","fragmentShaders","programs","delete","getVertexShader","source","_compareContexts","shader","getFragmentShader","getProgram","opts","vs","fs","id","cacheKey","_getProgramKey","program","_resetProgram","_createNewProgram","_checkProgramProp","_isCached","varyings","vertexShader","fragmentShader","Object","assign","reset","gl1","gl2"],"mappings":"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","sourcesContent":["import {VertexShader, FragmentShader} from '../../webgl/shader';\nimport Program from '../../webgl/program';\nimport assert from '../../utils/assert';\n\nexport default class ShaderCache {\n\n  /**\n   * A cache of compiled shaders, keyed by shader source strings.\n   * Compilation of long shaders can be time consuming.\n   * By using this class, the application can ensure that each shader\n   * is only compiled once.\n   */\n  constructor({gl, _cachePrograms = false} = {}) {\n    assert(gl);\n    this.gl = gl;\n    this.vertexShaders = {};\n    this.fragmentShaders = {};\n    this.programs = {};\n    this._cachePrograms = _cachePrograms;\n  }\n\n  /**\n   * Deletes shader references\n   * @return {ShaderCache} - returns this for chaining\n   */\n  delete() {\n    // TODO - requires reference counting to avoid deleting shaders in use\n    return this;\n  }\n\n  /**\n   * Returns a compiled `VertexShader` object corresponding to the supplied\n   * GLSL source code string, if possible from cache.\n   *\n   * @param {WebGLRenderingContext} gl - gl context\n   * @param {String} source - Source code for shader\n   * @return {VertexShader} - a compiled vertex shader\n   */\n  getVertexShader(gl, source) {\n    assert(typeof source === 'string');\n    assert(this._compareContexts(gl, this.gl));\n\n    let shader = this.vertexShaders[source];\n    if (!shader) {\n      shader = new VertexShader(gl, source);\n      this.vertexShaders[source] = shader;\n    }\n    return shader;\n  }\n\n  /**\n   * Returns a compiled `VertexShader` object corresponding to the supplied\n   * GLSL source code string, if possible from cache.\n   * @param {WebGLRenderingContext} gl - gl context\n   * @param {String} source - Source code for shader\n   * @return {FragmentShader} - a compiled fragment shader, possibly from chache\n   */\n  getFragmentShader(gl, source) {\n    assert(typeof source === 'string');\n    assert(this._compareContexts(gl, this.gl));\n\n    let shader = this.fragmentShaders[source];\n    if (!shader) {\n      shader = new FragmentShader(gl, source);\n      this.fragmentShaders[source] = shader;\n    }\n    return shader;\n  }\n\n  // Retrive Shaders from cache if exists, otherwise create new instance.\n  getProgram(gl, opts) {\n    assert(this._compareContexts(gl, this.gl));\n    assert(typeof opts.vs === 'string');\n    assert(typeof opts.fs === 'string');\n    assert(typeof opts.id === 'string');\n\n    const cacheKey = this._getProgramKey(opts);\n    let program = this.programs[cacheKey];\n    if (program) {\n      this._resetProgram(program);\n      return program;\n    }\n\n    program = this._createNewProgram(gl, opts);\n\n    // Check if program can be cached\n    // Program caching is experimental and expects\n    // each Model to have a unique-id (wich is used in key generation)\n    if (this._cachePrograms && this._checkProgramProp(program)) {\n      program._isCached = true;\n      this.programs[cacheKey] = program;\n    }\n\n    return program;\n  }\n\n  _getProgramKey(opts) {\n    return `${opts.id}-${opts.vs}-${opts.fs}`;\n  }\n\n  _checkProgramProp(program) {\n    // Check for transform feedback props (varyings, etc), we can't key such programs for now\n    return !program.varyings;\n  }\n\n  _createNewProgram(gl, opts) {\n    const {vs, fs} = opts;\n    const vertexShader = this.getVertexShader(gl, vs);\n    const fragmentShader = this.getFragmentShader(gl, fs);\n    return new Program(this.gl, Object.assign({}, opts, {\n      vs: vertexShader,\n      fs: fragmentShader\n    }));\n  }\n\n  _resetProgram(program, opts) {\n    program.reset();\n  }\n\n  // Handle debug contexts\n  _compareContexts(gl1, gl2) {\n    return (gl1.gl || gl1) === (gl2.gl || gl2);\n  }\n}\n"],"file":"shader-cache.js"}