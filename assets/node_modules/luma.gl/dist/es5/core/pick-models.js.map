{"version":3,"sources":["../../../src/core/pick-models.js"],"names":["ILLEGAL_ARG","getDevicePixelRatio","window","devicePixelRatio","pickModels","gl","models","position","uniforms","parameters","settings","useDevicePixelRatio","useDevicePixels","framebuffer","log","deprecated","x","y","resize","width","canvas","height","dpr","deviceX","deviceY","group","Group","children","traverseReverse","model","isPickable","color","depth","setUniforms","picking_uActive","draw","readPixels","format","RGBA","type","UNSIGNED_BYTE","isPicked"],"mappings":";;;;;;;AACA;;AACA;;AACA;;AACA;;;;;;;;;;;;AAEA,IAAMA,cAAc,0BAApB;;AAEA,SAASC,mBAAT,GAA+B;AAC7B,SAAO,OAAOC,MAAP,KAAkB,WAAlB,GAAgCA,OAAOC,gBAAvC,GAA0D,CAAjE;AACD;;AAEc,SAASC,UAAT,CAAoBC,EAApB,QASZ;AAAA,MARDC,MAQC,QARDA,MAQC;AAAA,MAPDC,QAOC,QAPDA,QAOC;AAAA,2BANDC,QAMC;AAAA,MANDA,QAMC,8BANU,EAMV;AAAA,6BALDC,UAKC;AAAA,MALDA,UAKC,gCALY,EAKZ;AAAA,MAJDC,QAIC,QAJDA,QAIC;AAAA,mCAHDC,mBAGC;AAAA,MAHDA,mBAGC,sCAHqB,IAGrB;AAAA,kCAFDC,eAEC;AAAA,MAFDA,eAEC,qCAFiB,IAEjB;AAAA,MADDC,WACC,QADDA,WACC;AACD,uBAAO,oBAAQR,EAAR,CAAP,EAAoBL,WAApB;AACA,uBAAOa,WAAP,EAAoBb,WAApB;AACA,uBAAOO,QAAP,EAAiBP,WAAjB;;AACA,MAAIW,wBAAwB,IAA5B,EAAkC;AAChCG,eAAIC,UAAJ,CAAe,qBAAf,EAAsC,iBAAtC;;AACAH,sBAAkBD,mBAAlB;AACD;;AAPA,iCAScJ,QATd;AAAA,MASMS,CATN;AAAA,MASSC,CATT,iBAWD;;;AACAJ,cAAYK,MAAZ,CAAmB;AAACC,WAAOd,GAAGe,MAAH,CAAUD,KAAlB;AAAyBE,YAAQhB,GAAGe,MAAH,CAAUC;AAA3C,GAAnB,EAZC,CAcD;AACA;;AACA,MAAMC,MAAMV,kBAAkBX,qBAAlB,GAA0C,CAAtD,CAhBC,CAiBD;;AACA,MAAMsB,UAAUP,IAAIM,GAApB;AACA,MAAME,UAAUnB,GAAGe,MAAH,CAAUC,MAAV,GAAmBJ,IAAIK,GAAvC,CAnBC,CAqBD;AACA;AACA;AACA;AACA;;AACA,MAAMG,QAAQ,IAAIC,cAAJ,CAAU;AAACC,cAAUrB;AAAX,GAAV,CAAd;AACA,SAAOmB,MAAMG,eAAN,CAAsB,iBAAS;AAEpC,QAAIC,MAAMC,UAAN,EAAJ,EAAwB;AACtB;AACA,wBAAMzB,EAAN,EAAU;AAACQ,gCAAD;AAAckB,eAAO,IAArB;AAA2BC,eAAO;AAAlC,OAAV,EAFsB,CAItB;;AACA;;AACAH,YAAMI,WAAN,CAAkB;AAACC,yBAAiB;AAAlB,OAAlB;AACAL,YAAMM,IAAN,CAAW;AAAC3B,0BAAD;AAAWC,8BAAX;AAAuBC,0BAAvB;AAAiCG;AAAjC,OAAX;AACAgB,YAAMI,WAAN,CAAkB;AAACC,yBAAiB;AAAlB,OAAlB,EARsB,CAUtB;;AACA,UAAMH,QAAQlB,YAAYuB,UAAZ,CAAuB;AACnCpB,WAAGO,OADgC;AAEnCN,WAAGO,OAFgC;AAGnCL,eAAO,CAH4B;AAInCE,gBAAQ,CAJ2B;AAKnCgB,gBAAQhC,GAAGiC,IALwB;AAMnCC,cAAMlC,GAAGmC;AAN0B,OAAvB,CAAd;AAQA,UAAMC,WAAWV,MAAM,CAAN,MAAa,CAAb,IAAkBA,MAAM,CAAN,MAAa,CAA/B,IAAoCA,MAAM,CAAN,MAAa,CAAlE,CAnBsB,CAqBtB;;AACA,UAAIU,QAAJ,EAAc;AACZ,eAAO;AACLZ,sBADK;AAELE,sBAFK;AAGLf,cAHK;AAILC,cAJK;AAKLM,0BALK;AAMLC;AANK,SAAP;AAQD;AACF;;AAED,WAAO,IAAP;AACD,GArCM,CAAP,CA3BC,CAiED;AACD","sourcesContent":["/* global window */\nimport {clear, isWebGL} from '../webgl';\nimport {log} from '../utils';\nimport Group from './group';\nimport assert from '../utils/assert';\n\nconst ILLEGAL_ARG = 'Illegal argument to pick';\n\nfunction getDevicePixelRatio() {\n  return typeof window !== 'undefined' ? window.devicePixelRatio : 1;\n}\n\nexport default function pickModels(gl, {\n  models,\n  position,\n  uniforms = {}, // eslint-disable-line\n  parameters = {},\n  settings,\n  useDevicePixelRatio = null, // deprecated\n  useDevicePixels = true,\n  framebuffer\n}) {\n  assert(isWebGL(gl), ILLEGAL_ARG);\n  assert(framebuffer, ILLEGAL_ARG);\n  assert(position, ILLEGAL_ARG);\n  if (useDevicePixelRatio !== null) {\n    log.deprecated('useDevicePixelRatio', 'useDevicePixels')();\n    useDevicePixels = useDevicePixelRatio;\n  }\n\n  const [x, y] = position;\n\n  // Match our picking framebuffer with the size of the canvas drawing buffer\n  framebuffer.resize({width: gl.canvas.width, height: gl.canvas.height});\n\n  // Compensate for devicePixelRatio\n  // Note: this assumes the canvas framebuffer has been matched\n  const dpr = useDevicePixels ? getDevicePixelRatio() : 1;\n  // Reverse the y coordinate\n  const deviceX = x * dpr;\n  const deviceY = gl.canvas.height - y * dpr;\n\n  // return withParameters(gl, {\n  //   // framebuffer,\n  //   // // We are only interested in one pixel, no need to render anything else\n  //   // scissorTest: {x: deviceX, y: deviceY, w: 1, h: 1}\n  // }, () => {\n  const group = new Group({children: models});\n  return group.traverseReverse(model => {\n\n    if (model.isPickable()) {\n      // Clear the frame buffer\n      clear(gl, {framebuffer, color: true, depth: true});\n\n      // Render picking colors\n      /* eslint-disable camelcase */\n      model.setUniforms({picking_uActive: 1});\n      model.draw({uniforms, parameters, settings, framebuffer});\n      model.setUniforms({picking_uActive: 0});\n\n      // Sample Read color in the central pixel, to be mapped as a picking color\n      const color = framebuffer.readPixels({\n        x: deviceX,\n        y: deviceY,\n        width: 1,\n        height: 1,\n        format: gl.RGBA,\n        type: gl.UNSIGNED_BYTE});\n\n      const isPicked = color[0] !== 0 || color[1] !== 0 || color[2] !== 0;\n\n      // Add the information to the stack\n      if (isPicked) {\n        return {\n          model,\n          color,\n          x,\n          y,\n          deviceX,\n          deviceY\n        };\n      }\n    }\n\n    return null;\n  });\n  // });\n}\n"],"file":"pick-models.js"}