{"version":3,"sources":["../../../src/lib/layer-manager.js"],"names":["assert","Framebuffer","ShaderCache","seer","Layer","drawLayers","pickObject","pickVisibleObjects","LIFECYCLE","ViewManager","MapView","log","flatten","Stats","setPropOverrides","layerEditListener","seerInitListener","initLayerInSeer","updateLayerInSeer","LOG_PRIORITY_LIFECYCLE","LOG_PRIORITY_LIFECYCLE_MINOR","INITIAL_CONTEXT","Object","seal","layerManager","gl","useDevicePixels","stats","viewport","shaderCache","pickingFBO","lastPickedInfo","index","layerId","userData","layerName","layer","LayerManager","eventManager","lastRenderedLayers","layers","context","assign","_cachePrograms","id","viewManager","layerFilter","drawPickingColors","_needsRedraw","_needsUpdate","_pickingRadius","_eventManager","_onLayerClick","_onLayerHover","_onClick","bind","_onPointerMove","_onPointerLeave","_pickAndCallback","_initSeer","_editSeer","width","height","_initEventHandling","setViews","removeListener","clearRedrawFlags","_checkIfNeedsRedraw","reason","layerIds","filter","find","indexOf","views","viewports","getViewports","length","_activateViewport","props","_setEventHandlingParameters","setSize","setViewState","viewState","setLayers","setNeedsRedraw","newLayers","Boolean","_updateLayers","oldLayers","error","generatedLayers","needsUpdate","pass","redrawReason","onViewportActive","x","y","mode","radius","depth","getLayers","_getPickingBuffer","parameters","setProps","deprecated","redraw","needsRedraw","layerNeedsRedraw","getNeedsRedraw","on","click","pointermove","pointerleave","pickingRadius","onLayerClick","onLayerHover","isNaN","_validateEventHandling","oldViewport","viewportChanged","equals","setChangeFlags","_updateLayer","resize","canvas","oldLayerMap","oldLayer","warn","_updateSublayersRecursively","error2","_finalizeOldLayers","firstError","newLayer","sublayers","_initializeLayer","_transferLayerState","push","isComposite","getSubLayers","err","_finalizeLayer","_initialize","lifecycle","INITIALIZED","internalState","getModels","model","_transferState","MATCHED","AWAITING_GC","printChangeFlags","_update","AWAITING_FINALIZATION","_finalize","FINALIZED","some","pickable","event","offsetCenter","callback","leftButton","rightButton","options","pos","selectedInfos","firstInfo","info","srcEvent","forEach","payload","type","valuePath","itemKey","slice","value","map","constructor","updateLayers"],"mappings":"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","sourcesContent":["// Copyright (c) 2015 - 2017 Uber Technologies, Inc.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\n\nimport assert from '../utils/assert';\nimport {Framebuffer, ShaderCache} from 'luma.gl';\nimport seer from 'seer';\nimport Layer from './layer';\nimport {drawLayers} from './draw-layers';\nimport {pickObject, pickVisibleObjects} from './pick-layers';\nimport {LIFECYCLE} from '../lifecycle/constants';\nimport ViewManager from '../views/view-manager';\nimport MapView from '../views/map-view';\nimport log from '../utils/log';\nimport {flatten} from '../utils/flatten';\nimport {Stats} from 'probe.gl';\n\nimport {\n  setPropOverrides,\n  layerEditListener,\n  seerInitListener,\n  initLayerInSeer,\n  updateLayerInSeer\n} from './seer-integration';\n\nconst LOG_PRIORITY_LIFECYCLE = 2;\nconst LOG_PRIORITY_LIFECYCLE_MINOR = 4;\n\n// CONTEXT IS EXPOSED TO LAYERS\nconst INITIAL_CONTEXT = Object.seal({\n  layerManager: null,\n  gl: null,\n\n  // Settings\n  useDevicePixels: true, // Exposed in case custom layers need to adjust sizes\n\n  // General resources\n  stats: null, // for tracking lifecycle performance\n  viewport: null, // Current viewport, exposed to layers for project* function\n\n  // GL Resources\n  shaderCache: null,\n  pickingFBO: null, // Screen-size framebuffer that layers can reuse\n\n  // State\n  lastPickedInfo: {\n    // For callback tracking and autohighlight\n    index: -1,\n    layerId: null\n  },\n\n  userData: {} // Place for any custom app `context`\n});\n\nconst layerName = layer => (layer instanceof Layer ? `${layer}` : !layer ? 'null' : 'invalid');\n\nexport default class LayerManager {\n  // eslint-disable-next-line\n  constructor(gl, {eventManager, stats} = {}) {\n    // Currently deck.gl expects the DeckGL.layers array to be different\n    // whenever React rerenders. If the same layers array is used, the\n    // LayerManager's diffing algorithm will generate a fatal error and\n    // break the rendering.\n\n    // `this.lastRenderedLayers` stores the UNFILTERED layers sent\n    // down to LayerManager, so that `layers` reference can be compared.\n    // If it's the same across two React render calls, the diffing logic\n    // will be skipped.\n    this.lastRenderedLayers = [];\n    this.layers = [];\n\n    this.context = Object.assign({}, INITIAL_CONTEXT, {\n      layerManager: this,\n\n      gl,\n      // Enabling luma.gl Program caching using private API (_cachePrograms)\n      shaderCache: new ShaderCache({gl, _cachePrograms: true}),\n      stats: stats || new Stats({id: 'deck.gl'})\n    });\n\n    // Maps view descriptors to vieports, rebuilds when width/height/viewState/views change\n    this.viewManager = new ViewManager();\n\n    this.layerFilter = null;\n    this.drawPickingColors = false;\n\n    this._needsRedraw = 'Initial render';\n    this._needsUpdate = false;\n\n    // Event handling\n    this._pickingRadius = 0;\n\n    this._eventManager = null;\n    this._onLayerClick = null;\n    this._onLayerHover = null;\n    this._onClick = this._onClick.bind(this);\n    this._onPointerMove = this._onPointerMove.bind(this);\n    this._onPointerLeave = this._onPointerLeave.bind(this);\n    this._pickAndCallback = this._pickAndCallback.bind(this);\n\n    // Seer integration\n    this._initSeer = this._initSeer.bind(this);\n    this._editSeer = this._editSeer.bind(this);\n\n    // DEPRECATED\n    this.width = 100;\n    this.height = 100;\n\n    Object.seal(this);\n\n    seerInitListener(this._initSeer);\n    layerEditListener(this._editSeer);\n\n    if (eventManager) {\n      this._initEventHandling(eventManager);\n    }\n\n    // Init with default map viewport\n    this.setViews();\n  }\n\n  // Method to call when the layer manager is not needed anymore.\n  // Currently used in the <DeckGL> componentWillUnmount lifecycle to unbind Seer listeners.\n  finalize() {\n    seer.removeListener(this._initSeer);\n    seer.removeListener(this._editSeer);\n  }\n\n  // Check if a redraw is needed\n  needsRedraw({clearRedrawFlags = true} = {}) {\n    return this._checkIfNeedsRedraw(clearRedrawFlags);\n  }\n\n  // Check if a deep update of all layers is needed\n  needsUpdate() {\n    return this._needsUpdate;\n  }\n\n  // Layers will be redrawn (in next animation frame)\n  setNeedsRedraw(reason) {\n    this._needsRedraw = this._needsRedraw || reason;\n  }\n\n  // Layers will be updated deeply (in next animation frame)\n  // Potentially regenerating attributes and sub layers\n  setNeedsUpdate(reason) {\n    this._needsUpdate = this._needsUpdate || reason;\n  }\n\n  // Gets an (optionally) filtered list of layers\n  getLayers({layerIds = null} = {}) {\n    // Filtering by layerId compares beginning of strings, so that sublayers will be included\n    // Dependes on the convention of adding suffixes to the parent's layer name\n    return layerIds\n      ? this.layers.filter(layer => layerIds.find(layerId => layer.id.indexOf(layerId) === 0))\n      : this.layers;\n  }\n\n  getViews() {\n    return this.viewManager.views;\n  }\n\n  // Get a set of viewports for a given width and height\n  getViewports() {\n    const viewports = this.viewManager.getViewports();\n    if (viewports.length) {\n      this._activateViewport(viewports[0]);\n    }\n    return viewports;\n  }\n\n  /**\n   * Set props needed for layer rendering and picking.\n   * Parameters are to be passed as a single object, with the following values:\n   * @param {Boolean} useDevicePixels\n   */\n  /* eslint-disable complexity, max-statements */\n  setProps(props) {\n    if ('eventManager' in props) {\n      this._initEventHandling(props.eventManager);\n    }\n\n    if ('pickingRadius' in props || 'onLayerClick' in props || 'onLayerHover' in props) {\n      this._setEventHandlingParameters(props);\n    }\n\n    if ('width' in props || 'height' in props) {\n      this.viewManager.setSize(props.width, props.height);\n      this.width = props.width;\n      this.height = props.height;\n    }\n\n    if ('views' in props) {\n      this.setViews(props.views);\n    }\n\n    // TODO - support multiple view states\n    if ('viewState' in props) {\n      this.viewManager.setViewState(props.viewState);\n    }\n\n    // TODO - For now we set layers before viewports to preserve changeFlags\n    if ('layers' in props) {\n      this.setLayers(props.layers);\n    }\n\n    if ('layerFilter' in props) {\n      if (this.layerFilter !== props.layerFilter) {\n        this.layerFilter = props.layerFilter;\n        this.setNeedsRedraw('layerFilter changed');\n      }\n    }\n\n    if ('drawPickingColors' in props) {\n      if (props.drawPickingColors !== this.drawPickingColors) {\n        this.drawPickingColors = props.drawPickingColors;\n        this.setNeedsRedraw('drawPickingColors changed');\n      }\n    }\n\n    // A way for apps to add data to context that can be accessed in layers\n    if ('userData' in props) {\n      this.context.userData = props.userData;\n    }\n\n    if ('useDevicePixels' in props) {\n      this.context.useDevicePixels = props.useDevicePixels;\n    }\n  }\n  /* eslint-enable complexity, max-statements */\n\n  // Update the view descriptor list and set change flag if needed\n  // Does not actually rebuild the `Viewport`s until `getViewports` is called\n  setViews(views) {\n    // For now, we default to a full screen map view port\n    // TODO - apps may want to specify an empty view list...\n    if (!views || views.length === 0) {\n      views = [new MapView({id: 'default-view'})];\n    }\n\n    this.viewManager.setViews(views);\n  }\n\n  // Supply a new layer list, initiating sublayer generation and layer matching\n  setLayers(newLayers) {\n    this.getViewports();\n    assert(this.context.viewport, 'LayerManager.updateLayers: viewport not set');\n\n    // TODO - something is generating state updates that cause rerender of the same\n    if (newLayers === this.lastRenderedLayers) {\n      log.log(3, 'Ignoring layer update due to layer array not changed')();\n      return this;\n    }\n    this.lastRenderedLayers = newLayers;\n\n    newLayers = flatten(newLayers, {filter: Boolean});\n\n    for (const layer of newLayers) {\n      layer.context = this.context;\n    }\n\n    const {error, generatedLayers} = this._updateLayers({\n      oldLayers: this.layers,\n      newLayers\n    });\n\n    this.layers = generatedLayers;\n\n    // Throw first error found, if any\n    if (error) {\n      throw error;\n    }\n    return this;\n  }\n\n  // Update layers from last cycle if `setNeedsUpdate()` has been called\n  updateLayers() {\n    // NOTE: For now, even if only some layer has changed, we update all layers\n    // to ensure that layer id maps etc remain consistent even if different\n    // sublayers are rendered\n    const reason = this.needsUpdate();\n    if (reason) {\n      this.setNeedsRedraw(`updating layers: ${reason}`);\n      // HACK - Call with a copy of lastRenderedLayers to trigger a full update\n      this.setLayers([...this.lastRenderedLayers]);\n    }\n  }\n\n  //\n  // METHODS FOR LAYERS\n  //\n\n  // Draw all layers in all views\n  drawLayers({pass = 'render to screen', redrawReason = 'unknown reason'} = {}) {\n    const {drawPickingColors} = this;\n    const {gl, useDevicePixels} = this.context;\n\n    // render this viewport\n    drawLayers(gl, {\n      layers: this.layers,\n      viewports: this.getViewports(),\n      onViewportActive: this._activateViewport.bind(this),\n      useDevicePixels,\n      drawPickingColors,\n      pass,\n      layerFilter: this.layerFilter,\n      redrawReason\n    });\n  }\n\n  // Pick the closest info at given coordinate\n  pickObject({x, y, mode, radius = 0, layerIds, layerFilter, depth = 1}) {\n    const {gl, useDevicePixels} = this.context;\n\n    const layers = this.getLayers({layerIds});\n\n    return pickObject(gl, {\n      // User params\n      x,\n      y,\n      radius,\n      layers,\n      mode,\n      layerFilter,\n      depth,\n      // Injected params\n      viewports: this.getViewports(),\n      onViewportActive: this._activateViewport.bind(this),\n      pickingFBO: this._getPickingBuffer(),\n      lastPickedInfo: this.context.lastPickedInfo,\n      useDevicePixels\n    });\n  }\n\n  // Get all unique infos within a bounding box\n  pickObjects({x, y, width, height, layerIds, layerFilter}) {\n    const {gl, useDevicePixels} = this.context;\n\n    const layers = this.getLayers({layerIds});\n\n    return pickVisibleObjects(gl, {\n      x,\n      y,\n      width,\n      height,\n      layers,\n      layerFilter,\n      mode: 'pickObjects',\n      viewports: this.getViewports(),\n      onViewportActive: this._activateViewport.bind(this),\n      pickingFBO: this._getPickingBuffer(),\n      useDevicePixels\n    });\n  }\n\n  //\n  // DEPRECATED METHODS in V5.3\n  //\n\n  setParameters(parameters) {\n    return this.setProps(parameters);\n  }\n\n  setSize(width, height) {\n    this.setProps({width, height});\n  }\n\n  setViewState(viewState) {\n    this.setProps({viewState});\n  }\n\n  //\n  // DEPRECATED METHODS in V5.1\n  //\n\n  setViewports(viewports) {\n    log.deprecated('setViewport', 'setViews')();\n    this.setViews(viewports);\n    return this;\n  }\n\n  //\n  // DEPRECATED METHODS in V5\n  //\n\n  setViewport(viewport) {\n    log.deprecated('setViewport', 'setViews')();\n    this.setViews([viewport]);\n    return this;\n  }\n\n  //\n  // PRIVATE METHODS\n  //\n\n  _checkIfNeedsRedraw(clearRedrawFlags) {\n    let redraw = this._needsRedraw;\n    if (clearRedrawFlags) {\n      this._needsRedraw = false;\n    }\n\n    redraw = redraw || this.viewManager.needsRedraw();\n\n    // This layers list doesn't include sublayers, relying on composite layers\n    for (const layer of this.layers) {\n      // Call every layer to clear their flags\n      const layerNeedsRedraw = layer.getNeedsRedraw({clearRedrawFlags});\n      redraw = redraw || layerNeedsRedraw;\n    }\n\n    return redraw;\n  }\n\n  /**\n   * @param {Object} eventManager   A source of DOM input events\n   */\n  _initEventHandling(eventManager) {\n    this._eventManager = eventManager;\n\n    // TODO: add/remove handlers on demand at runtime, not all at once on init.\n    // Consider both top-level handlers like onLayerClick/Hover\n    // and per-layer handlers attached to individual layers.\n    // https://github.com/uber/deck.gl/issues/634\n    this._eventManager.on({\n      click: this._onClick,\n      pointermove: this._onPointerMove,\n      pointerleave: this._onPointerLeave\n    });\n  }\n\n  // Set parameters for input event handling.\n  _setEventHandlingParameters({pickingRadius, onLayerClick, onLayerHover}) {\n    if (!isNaN(pickingRadius)) {\n      this._pickingRadius = pickingRadius;\n    }\n    if (typeof onLayerClick !== 'undefined') {\n      this._onLayerClick = onLayerClick;\n    }\n    if (typeof onLayerHover !== 'undefined') {\n      this._onLayerHover = onLayerHover;\n    }\n    this._validateEventHandling();\n  }\n\n  // Make a viewport \"current\" in layer context, updating viewportChanged flags\n  _activateViewport(viewport) {\n    const oldViewport = this.context.viewport;\n    const viewportChanged = !oldViewport || !viewport.equals(oldViewport);\n\n    if (viewportChanged) {\n      log.log(4, 'Viewport changed', viewport)();\n\n      this.context.viewport = viewport;\n\n      // Update layers states\n      // Let screen space layers update their state based on viewport\n      for (const layer of this.layers) {\n        layer.setChangeFlags({viewportChanged: 'Viewport changed'});\n        this._updateLayer(layer);\n      }\n    }\n\n    assert(this.context.viewport, 'LayerManager: viewport not set');\n\n    return this;\n  }\n\n  _getPickingBuffer() {\n    const {gl} = this.context;\n    // Create a frame buffer if not already available\n    this.context.pickingFBO = this.context.pickingFBO || new Framebuffer(gl);\n    // Resize it to current canvas size (this is a noop if size hasn't changed)\n    this.context.pickingFBO.resize({width: gl.canvas.width, height: gl.canvas.height});\n    return this.context.pickingFBO;\n  }\n\n  // Match all layers, checking for caught errors\n  // To avoid having an exception in one layer disrupt other layers\n  // TODO - mark layers with exceptions as bad and remove from rendering cycle?\n  _updateLayers({oldLayers, newLayers}) {\n    // Create old layer map\n    const oldLayerMap = {};\n    for (const oldLayer of oldLayers) {\n      if (oldLayerMap[oldLayer.id]) {\n        log.warn(`Multiple old layers with same id ${layerName(oldLayer)}`)();\n      } else {\n        oldLayerMap[oldLayer.id] = oldLayer;\n      }\n    }\n\n    // Allocate array for generated layers\n    const generatedLayers = [];\n\n    // Match sublayers\n    const error = this._updateSublayersRecursively({\n      newLayers,\n      oldLayerMap,\n      generatedLayers\n    });\n\n    // Finalize unmatched layers\n    const error2 = this._finalizeOldLayers(oldLayerMap);\n\n    this._needsUpdate = false;\n\n    const firstError = error || error2;\n    return {error: firstError, generatedLayers};\n  }\n\n  // Note: adds generated layers to `generatedLayers` array parameter\n  _updateSublayersRecursively({newLayers, oldLayerMap, generatedLayers}) {\n    let error = null;\n\n    for (const newLayer of newLayers) {\n      newLayer.context = this.context;\n\n      // Given a new coming layer, find its matching old layer (if any)\n      const oldLayer = oldLayerMap[newLayer.id];\n      if (oldLayer === null) {\n        // null, rather than undefined, means this id was originally there\n        log.warn(`Multiple new layers with same id ${layerName(newLayer)}`)();\n      }\n      // Remove the old layer from candidates, as it has been matched with this layer\n      oldLayerMap[newLayer.id] = null;\n\n      let sublayers = null;\n\n      // We must not generate exceptions until after layer matching is complete\n      try {\n        if (!oldLayer) {\n          this._initializeLayer(newLayer);\n          initLayerInSeer(newLayer); // Initializes layer in seer chrome extension (if connected)\n        } else {\n          this._transferLayerState(oldLayer, newLayer);\n          this._updateLayer(newLayer);\n          updateLayerInSeer(newLayer); // Updates layer in seer chrome extension (if connected)\n        }\n        generatedLayers.push(newLayer);\n\n        // Call layer lifecycle method: render sublayers\n        sublayers = newLayer.isComposite && newLayer.getSubLayers();\n        // End layer lifecycle method: render sublayers\n      } catch (err) {\n        log.warn(`error during matching of ${layerName(newLayer)}`, err);\n        error = error || err; // Record first exception\n      }\n\n      if (sublayers) {\n        this._updateSublayersRecursively({\n          newLayers: sublayers,\n          oldLayerMap,\n          generatedLayers\n        });\n      }\n    }\n\n    return error;\n  }\n\n  // Finalize any old layers that were not matched\n  _finalizeOldLayers(oldLayerMap) {\n    let error = null;\n    for (const layerId in oldLayerMap) {\n      const layer = oldLayerMap[layerId];\n      if (layer) {\n        error = error || this._finalizeLayer(layer);\n      }\n    }\n    return error;\n  }\n\n  // EXCEPTION SAFE LAYER ACCESS\n\n  // Initializes a single layer, calling layer methods\n  _initializeLayer(layer) {\n    log.log(LOG_PRIORITY_LIFECYCLE, `initializing ${layerName(layer)}`)();\n\n    let error = null;\n    try {\n      layer._initialize();\n      layer.lifecycle = LIFECYCLE.INITIALIZED;\n    } catch (err) {\n      log.warn(`error while initializing ${layerName(layer)}\\n`, err)();\n      error = error || err;\n      // TODO - what should the lifecycle state be here? LIFECYCLE.INITIALIZATION_FAILED?\n    }\n\n    // Set back pointer (used in picking)\n    layer.internalState.layer = layer;\n\n    // Save layer on model for picking purposes\n    // store on model.userData rather than directly on model\n    for (const model of layer.getModels()) {\n      model.userData.layer = layer;\n    }\n\n    return error;\n  }\n\n  _transferLayerState(oldLayer, newLayer) {\n    newLayer._transferState(oldLayer);\n    newLayer.lifecycle = LIFECYCLE.MATCHED;\n\n    if (newLayer !== oldLayer) {\n      log.log(\n        LOG_PRIORITY_LIFECYCLE_MINOR,\n        `matched ${layerName(newLayer)}`,\n        oldLayer,\n        '->',\n        newLayer\n      )();\n      oldLayer.lifecycle = LIFECYCLE.AWAITING_GC;\n    } else {\n      log.log(LOG_PRIORITY_LIFECYCLE_MINOR, `Matching layer is unchanged ${newLayer.id}`)();\n    }\n  }\n\n  // Updates a single layer, cleaning all flags\n  _updateLayer(layer) {\n    log.log(\n      LOG_PRIORITY_LIFECYCLE_MINOR,\n      `updating ${layer} because: ${layer.printChangeFlags()}`\n    )();\n    let error = null;\n    try {\n      layer._update();\n    } catch (err) {\n      log.warn(`error during update of ${layerName(layer)}`, err)();\n      // Save first error\n      error = err;\n    }\n    return error;\n  }\n\n  // Finalizes a single layer\n  _finalizeLayer(layer) {\n    assert(layer.lifecycle !== LIFECYCLE.AWAITING_FINALIZATION);\n    layer.lifecycle = LIFECYCLE.AWAITING_FINALIZATION;\n    let error = null;\n    this.setNeedsRedraw(`finalized ${layerName(layer)}`);\n    try {\n      layer._finalize();\n    } catch (err) {\n      log.warn(`error during finalization of ${layerName(layer)}`, err)();\n      error = err;\n    }\n    layer.lifecycle = LIFECYCLE.FINALIZED;\n    log.log(LOG_PRIORITY_LIFECYCLE, `finalizing ${layerName(layer)}`);\n    return error;\n  }\n\n  /**\n   * Warn if a deck-level mouse event has been specified,\n   * but no layers are `pickable`.\n   */\n  _validateEventHandling() {\n    if (this.onLayerClick || this.onLayerHover) {\n      if (this.layers.length && !this.layers.some(layer => layer.props.pickable)) {\n        log.warn(\n          'You have supplied a top-level input event handler (e.g. `onLayerClick`), ' +\n            'but none of your layers have set the `pickable` flag.'\n        )();\n      }\n    }\n  }\n\n  /**\n   * Route click events to layers.\n   * `pickLayer` will call the `onClick` prop of any picked layer,\n   * and `onLayerClick` is called directly from here\n   * with any picking info generated by `pickLayer`.\n   * @param {Object} event  An object encapsulating an input event,\n   *                        with the following shape:\n   *                        {Object: {x, y}} offsetCenter: center of the event\n   *                        {Object} srcEvent:             native JS Event object\n   */\n  _onClick(event) {\n    if (!event.offsetCenter) {\n      // Do not trigger onHover callbacks when click position is invalid.\n      return;\n    }\n    this._pickAndCallback({\n      callback: this._onLayerClick,\n      event,\n      mode: 'click'\n    });\n  }\n\n  /**\n   * Route click events to layers.\n   * `pickLayer` will call the `onHover` prop of any picked layer,\n   * and `onLayerHover` is called directly from here\n   * with any picking info generated by `pickLayer`.\n   * @param {Object} event  An object encapsulating an input event,\n   *                        with the following shape:\n   *                        {Object: {x, y}} offsetCenter: center of the event\n   *                        {Object} srcEvent:             native JS Event object\n   */\n  _onPointerMove(event) {\n    if (event.leftButton || event.rightButton) {\n      // Do not trigger onHover callbacks if mouse button is down.\n      return;\n    }\n    this._pickAndCallback({\n      callback: this._onLayerHover,\n      event,\n      mode: 'hover'\n    });\n  }\n\n  _onPointerLeave(event) {\n    this.pickObject({\n      x: -1,\n      y: -1,\n      radius: this._pickingRadius,\n      mode: 'hover'\n    });\n  }\n\n  _pickAndCallback(options) {\n    const pos = options.event.offsetCenter;\n    const radius = this._pickingRadius;\n    const selectedInfos = this.pickObject({x: pos.x, y: pos.y, radius, mode: options.mode});\n    if (options.callback) {\n      const firstInfo = selectedInfos.find(info => info.index >= 0) || null;\n      // As per documentation, send null value when no valid object is picked.\n      options.callback(firstInfo, selectedInfos, options.event.srcEvent);\n    }\n  }\n\n  // SEER INTEGRATION\n\n  /**\n   * Called upon Seer initialization, manually sends layers data.\n   */\n  _initSeer() {\n    this.layers.forEach(layer => {\n      initLayerInSeer(layer);\n      updateLayerInSeer(layer);\n    });\n  }\n\n  /**\n   * On Seer property edition, set override and update layers.\n   */\n  _editSeer(payload) {\n    if (payload.type !== 'edit' || payload.valuePath[0] !== 'props') {\n      return;\n    }\n\n    setPropOverrides(payload.itemKey, payload.valuePath.slice(1), payload.value);\n    const newLayers = this.layers.map(layer => new layer.constructor(layer.props));\n    this.updateLayers({newLayers});\n  }\n}\n"],"file":"layer-manager.js"}