{"version":3,"sources":["../../../src/views/view-manager.js"],"names":["assert","deepEqual","View","Viewport","log","flatten","INITIAL_VIEW_STATE","latitude","longitude","zoom","ViewManager","constructor","props","views","width","height","viewState","_viewports","_needsRedraw","_needsUpdate","Object","seal","setProps","finalize","needsRedraw","clearRedrawFlags","redraw","setNeedsRedraw","reason","setNeedsUpdate","getViewports","_rebuildViewportsFromViews","project","xyz","opts","topLeft","viewports","i","length","viewport","contains","unproject","containsPixel","setViews","setViewState","setSize","context","useDevicePixels","Number","isFinite","filter","Boolean","map","view","viewportInstance","viewsChanged","_diffViews","viewStateChanged","warn","updateReason","makeViewport","newViews","oldViews","some","_","equals"],"mappings":"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","sourcesContent":["// Copyright (c) 2015 - 2017 Uber Technologies, Inc.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\n\nimport assert from '../utils/assert';\nimport {deepEqual} from '../utils/deep-equal';\nimport View from '../views/view';\nimport Viewport from '../viewports/viewport';\nimport log from '../utils/log';\nimport {flatten} from '../utils/flatten';\n\nconst INITIAL_VIEW_STATE = {latitude: 0, longitude: 0, zoom: 1};\n\nexport default class ViewManager {\n  constructor(props = {}) {\n    // List of view descriptors, gets re-evaluated when width/height changes\n    this.views = [];\n    this.width = 100;\n    this.height = 100;\n    this.viewState = INITIAL_VIEW_STATE;\n\n    this._viewports = []; // Generated viewports\n    this._needsRedraw = 'Initial render';\n    this._needsUpdate = true;\n\n    Object.seal(this);\n\n    // Init with default map viewport\n    this.setProps(props);\n  }\n\n  finalize() {}\n\n  // Check if a redraw is needed\n  needsRedraw({clearRedrawFlags = true} = {}) {\n    const redraw = this._needsRedraw;\n    if (clearRedrawFlags) {\n      this._needsRedraw = false;\n    }\n    return redraw;\n  }\n\n  // Layers will be redrawn (in next animation frame)\n  setNeedsRedraw(reason) {\n    this._needsRedraw = this._needsRedraw || reason;\n  }\n\n  // Layers will be updated deeply (in next animation frame)\n  // Potentially regenerating attributes and sub layers\n  setNeedsUpdate(reason) {\n    this._needsUpdate = this._needsUpdate || reason;\n    this._needsRedraw = this._needsRedraw || reason;\n  }\n\n  // Get a set of viewports for a given width and height\n  // TODO - Intention is for deck.gl to autodeduce width and height and drop the need for props\n  getViewports() {\n    this._rebuildViewportsFromViews();\n    return this._viewports;\n  }\n\n  /**\n   * Projects xyz (possibly latitude and longitude) to pixel coordinates in window\n   * using viewport projection parameters\n   * - [longitude, latitude] to [x, y]\n   * - [longitude, latitude, Z] => [x, y, z]\n   * Note: By default, returns top-left coordinates for canvas/SVG type render\n   *\n   * @param {Array} lngLatZ - [lng, lat] or [lng, lat, Z]\n   * @param {Object} opts - options\n   * @param {Object} opts.topLeft=true - Whether projected coords are top left\n   * @return {Array} - [x, y] or [x, y, z] in top left coords\n   */\n  project(xyz, opts = {topLeft: true}) {\n    const viewports = this.getViewports();\n    for (let i = viewports.length - 1; i >= 0; --i) {\n      const viewport = viewports[i];\n      if (viewport.contains(xyz, opts)) {\n        return viewport.project(xyz, opts);\n      }\n    }\n    return null;\n  }\n\n  /**\n   * Unproject pixel coordinates on screen onto world coordinates,\n   * (possibly [lon, lat]) on map.\n   * - [x, y] => [lng, lat]\n   * - [x, y, z] => [lng, lat, Z]\n   * @param {Array} xyz -\n   * @param {Object} opts - options\n   * @param {Object} opts.topLeft=true - Whether origin is top left\n   * @return {Array|null} - [lng, lat, Z] or [X, Y, Z]\n   */\n  unproject(xyz, opts) {\n    const viewports = this.getViewports();\n    for (let i = viewports.length - 1; i >= 0; --i) {\n      const viewport = viewports[i];\n      if (viewport.containsPixel(xyz, opts)) {\n        return viewport.unproject(xyz);\n      }\n    }\n    return null;\n  }\n\n  /**\n   * Set props needed for layer rendering and picking.\n   * Parameters are to be passed as a single object, with the following values:\n   * @param {Boolean} useDevicePixels\n   */\n  /* eslint-disable complexity */\n  setProps(props) {\n    if ('views' in props) {\n      this.setViews(props.views);\n    }\n\n    // TODO - support multiple view states\n    if ('viewState' in props) {\n      this.setViewState(props.viewState);\n    }\n\n    if ('width' in props || 'height' in props) {\n      this.setSize(props.width, props.height);\n    }\n\n    if ('useDevicePixels' in props) {\n      this.context.useDevicePixels = props.useDevicePixels;\n    }\n  }\n  /* eslint-enable complexity */\n\n  setSize(width, height) {\n    assert(Number.isFinite(width) && Number.isFinite(height));\n    if (width !== this.width || height !== this.height) {\n      this.width = width;\n      this.height = height;\n      this.setNeedsUpdate('Size changed');\n    }\n  }\n\n  // Update the view descriptor list and set change flag if needed\n  // Does not actually rebuild the `Viewport`s until `getViewports` is called\n  setViews(views) {\n    // DEPRECATED: Ensure any \"naked\" Viewports are wrapped in View instances\n    views = flatten(views, {filter: Boolean}).map(\n      view => (view instanceof Viewport ? new View({viewportInstance: view}) : view)\n    );\n\n    const viewsChanged = this._diffViews(views, this.views);\n    if (viewsChanged) {\n      this.setNeedsUpdate('views changed');\n    }\n\n    this.views = views;\n  }\n\n  setViewState(viewState) {\n    if (viewState) {\n      const viewStateChanged = deepEqual(viewState, this.viewState);\n\n      if (viewStateChanged) {\n        this.setNeedsUpdate('viewState changed');\n      }\n\n      this.viewState = viewState;\n    } else {\n      log.warn('setting null viewState')();\n    }\n  }\n\n  //\n  // PRIVATE METHODS\n  //\n\n  // Rebuilds viewports from descriptors towards a certain window size\n  _rebuildViewportsFromViews() {\n    const updateReason = this._needsUpdate;\n    if (updateReason) {\n      const {width, height, views, viewState} = this;\n\n      this._viewports = views.map(view => view.makeViewport({width, height, viewState}));\n\n      // We've just rebuilt the Viewports to match the View descriptors,\n      // so clear the update flag and set the render flag\n      this._needsUpdate = false;\n    }\n  }\n\n  // Check if viewport array has changed, returns true if any change\n  // Note that descriptors can be the same\n  _diffViews(newViews, oldViews) {\n    if (newViews.length !== oldViews.length) {\n      return true;\n    }\n\n    return newViews.some((_, i) => !newViews[i].equals(oldViews[i]));\n  }\n}\n"],"file":"view-manager.js"}