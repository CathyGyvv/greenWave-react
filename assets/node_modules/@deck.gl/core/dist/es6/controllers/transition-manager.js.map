{"version":3,"sources":["../../../src/controllers/transition-manager.js"],"names":["LinearInterpolator","Transition","assert","noop","TRANSITION_EVENTS","BREAK","SNAP_TO_END","IGNORE","DEFAULT_PROPS","transitionDuration","transitionEasing","t","transitionInterpolator","transitionInterruption","onTransitionStart","onTransitionInterrupt","onTransitionEnd","TransitionManager","constructor","ControllerState","props","Object","assign","animation","propsInTransition","transition","_onTransitionFrame","bind","_onTransitionUpdate","getViewportInTransition","processViewStateChange","nextProps","transitionTriggered","currentProps","_shouldIgnoreViewportChange","_isTransitionEnabled","startProps","interruption","endProps","_triggerTransition","cancel","_isUpdateDueToCurrentTransition","inProgress","interpolator","arePropsEqual","cancelAnimationFrame","startViewstate","endViewStateProps","shortestPathFrom","initialProps","initializeProps","start","duration","easing","end","onStart","onUpdate","onInterrupt","_onTransitionEnd","onEnd","requestAnimationFrame","update","Date","now","callback","time","viewport","interpolateProps","getViewportProps","onViewportChange","inTransition","onViewStateChange","viewState","defaultProps"],"mappings":"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","sourcesContent":["/* global requestAnimationFrame, cancelAnimationFrame */\nimport LinearInterpolator from '../transitions/linear-interpolator';\nimport Transition from '../transitions/transition';\nimport assert from '../utils/assert';\n\nconst noop = () => {};\n\nexport const TRANSITION_EVENTS = {\n  BREAK: 1,\n  SNAP_TO_END: 2,\n  IGNORE: 3\n};\n\nconst DEFAULT_PROPS = {\n  transitionDuration: 0,\n  transitionEasing: t => t,\n  transitionInterpolator: new LinearInterpolator(),\n  transitionInterruption: TRANSITION_EVENTS.BREAK,\n  onTransitionStart: noop,\n  onTransitionInterrupt: noop,\n  onTransitionEnd: noop\n};\n\nexport default class TransitionManager {\n  constructor(ControllerState, props = {}) {\n    assert(ControllerState);\n    this.ControllerState = ControllerState;\n    this.props = Object.assign({}, DEFAULT_PROPS, props);\n    this.animation = null;\n    this.propsInTransition = null;\n    this.transition = new Transition();\n\n    this._onTransitionFrame = this._onTransitionFrame.bind(this);\n    this._onTransitionUpdate = this._onTransitionUpdate.bind(this);\n  }\n\n  // Returns current transitioned viewport.\n  getViewportInTransition() {\n    return this.propsInTransition;\n  }\n\n  // Process the vewiport change, either ignore or trigger a new transition.\n  // Return true if a new transition is triggered, false otherwise.\n  processViewStateChange(nextProps) {\n    let transitionTriggered = false;\n    const currentProps = this.props;\n    // Set this.props here as '_triggerTransition' calls '_updateViewport' that uses this.props.\n    nextProps = Object.assign({}, this.props, nextProps);\n    this.props = nextProps;\n\n    // NOTE: Be cautious re-ordering statements in this function.\n    if (this._shouldIgnoreViewportChange(currentProps, nextProps)) {\n      return transitionTriggered;\n    }\n\n    if (this._isTransitionEnabled(nextProps)) {\n      const startProps = Object.assign(\n        {},\n        currentProps,\n        this.transition.interruption === TRANSITION_EVENTS.SNAP_TO_END\n          ? this.transition.endProps\n          : this.propsInTransition || currentProps\n      );\n\n      this._triggerTransition(startProps, nextProps);\n\n      transitionTriggered = true;\n    } else {\n      this.transition.cancel();\n    }\n\n    return transitionTriggered;\n  }\n\n  // Helper methods\n\n  _isTransitionEnabled(props) {\n    return props.transitionDuration > 0 && props.transitionInterpolator;\n  }\n\n  _isUpdateDueToCurrentTransition(props) {\n    if (this.transition.inProgress) {\n      return this.transition.interpolator.arePropsEqual(props, this.propsInTransition);\n    }\n    return false;\n  }\n\n  _shouldIgnoreViewportChange(currentProps, nextProps) {\n    if (this.transition.inProgress) {\n      // Ignore update if it is requested to be ignored\n      return (\n        this.transition.interruption === TRANSITION_EVENTS.IGNORE ||\n        // Ignore update if it is due to current active transition.\n        this._isUpdateDueToCurrentTransition(nextProps)\n      );\n    } else if (this._isTransitionEnabled(nextProps)) {\n      // Ignore if none of the viewport props changed.\n      return nextProps.transitionInterpolator.arePropsEqual(currentProps, nextProps);\n    }\n    return true;\n  }\n\n  _triggerTransition(startProps, endProps) {\n    assert(this._isTransitionEnabled(endProps), 'Transition is not enabled');\n\n    cancelAnimationFrame(this.animation);\n\n    const startViewstate = new this.ControllerState(startProps);\n    const endViewStateProps = new this.ControllerState(endProps).shortestPathFrom(startViewstate);\n\n    const initialProps = endProps.transitionInterpolator.initializeProps(\n      startProps,\n      endViewStateProps\n    );\n\n    this.propsInTransition = {};\n    this.transition.start({\n      duration: endProps.transitionDuration,\n      easing: endProps.transitionEasing,\n      interpolator: endProps.transitionInterpolator,\n      interruption: endProps.transitionInterruption,\n\n      startProps: initialProps.start,\n      endProps: initialProps.end,\n\n      onStart: endProps.onTransitionStart,\n      onUpdate: this._onTransitionUpdate,\n      onInterrupt: this._onTransitionEnd(endProps.onTransitionInterrupt),\n      onEnd: this._onTransitionEnd(endProps.onTransitionEnd)\n    });\n\n    this._onTransitionFrame();\n  }\n\n  _onTransitionFrame() {\n    // _updateViewport() may cancel the animation\n    this.animation = requestAnimationFrame(this._onTransitionFrame);\n    this.transition.update(Date.now());\n  }\n\n  _onTransitionEnd(callback) {\n    return transition => {\n      cancelAnimationFrame(this.animation);\n      this.propsInTransition = null;\n      callback(transition);\n    };\n  }\n\n  _onTransitionUpdate(transition) {\n    // NOTE: Be cautious re-ordering statements in this function.\n    const {interpolator, startProps, endProps, time} = transition;\n\n    const viewport = interpolator.interpolateProps(startProps, endProps, time);\n\n    // This gurantees all props (e.g. bearing, longitude) are normalized\n    // So when viewports are compared they are in same range.\n    this.propsInTransition = new this.ControllerState(\n      Object.assign({}, this.props, viewport)\n    ).getViewportProps();\n\n    if (this.props.onViewportChange) {\n      this.props.onViewportChange(this.propsInTransition, {inTransition: true});\n    }\n    if (this.props.onViewStateChange) {\n      this.props.onViewStateChange({viewState: this.propsInTransition}, {inTransition: true});\n    }\n  }\n}\n\nTransitionManager.defaultProps = DEFAULT_PROPS;\n"],"file":"transition-manager.js"}