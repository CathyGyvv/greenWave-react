{"version":3,"sources":["../../../src/lifecycle/props.js"],"names":["assert","diffProps","props","oldProps","propsChangedReason","compareProps","newProps","ignoreProps","data","updateTriggers","dataChangedReason","diffDataProps","updateTriggersChangedReason","diffUpdateTriggers","dataChanged","propsChanged","updateTriggersChanged","shallowCompareProps","triggerName","undefined","key","equals","call","type","dataComparator","diffReason","diffUpdateTrigger","all","triggerChanged","reason","newTriggers","oldTriggers"],"mappings":"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","sourcesContent":["import assert from '../utils/assert';\n\n// Returns an object with \"change flags\", either false or strings indicating reason for change\nexport function diffProps(props, oldProps) {\n  // First check if any props have changed (ignore props that will be examined separately)\n  const propsChangedReason = compareProps({\n    newProps: props,\n    oldProps,\n    ignoreProps: {data: null, updateTriggers: null}\n  });\n\n  // Now check if any data related props have changed\n  const dataChangedReason = diffDataProps(props, oldProps);\n\n  // Check update triggers to determine if any attributes need regeneration\n  // Note - if data has changed, all attributes will need regeneration, so skip this step\n  let updateTriggersChangedReason = false;\n  if (!dataChangedReason) {\n    updateTriggersChangedReason = diffUpdateTriggers(props, oldProps);\n  }\n\n  return {\n    dataChanged: dataChangedReason,\n    propsChanged: propsChangedReason,\n    updateTriggersChanged: updateTriggersChangedReason\n  };\n}\n\n/**\n * Performs equality by iterating through keys on an object and returning false\n * when any key has values which are not strictly equal between the arguments.\n * @param {Object} opt.oldProps - object with old key/value pairs\n * @param {Object} opt.newProps - object with new key/value pairs\n * @param {Object} opt.ignoreProps={} - object, keys that should not be compared\n * @returns {null|String} - null when values of all keys are strictly equal.\n *   if unequal, returns a string explaining what changed.\n */\n/* eslint-disable max-statements, max-depth, complexity */\nexport function compareProps({\n  newProps,\n  oldProps,\n  ignoreProps = {},\n  shallowCompareProps = {},\n  triggerName = 'props'\n} = {}) {\n  assert(oldProps !== undefined && newProps !== undefined, 'compareProps args');\n\n  // shallow equality => deep equality\n  if (oldProps === newProps) {\n    return null;\n  }\n\n  // TODO - do we need these checks? Should never happen...\n  if (typeof newProps !== 'object' || newProps === null) {\n    return `${triggerName} changed shallowly`;\n  }\n\n  if (typeof oldProps !== 'object' || oldProps === null) {\n    return `${triggerName} changed shallowly`;\n  }\n\n  // Test if new props different from old props\n  for (const key in oldProps) {\n    if (!(key in ignoreProps)) {\n      if (!(key in newProps)) {\n        return `${triggerName}.${key} dropped: ${oldProps[key]} -> undefined`;\n      }\n\n      // If object has an equals function, invoke it\n      let equals = newProps[key] && oldProps[key] && newProps[key].equals;\n      if (equals && !equals.call(newProps[key], oldProps[key])) {\n        return `${triggerName}.${key} changed deeply: ${oldProps[key]} -> ${newProps[key]}`;\n      }\n\n      // If both new and old value are functions, ignore differences\n      if (key in shallowCompareProps) {\n        const type = typeof newProps[key];\n        if (type === 'function' && typeof oldProps[key] === 'function') {\n          equals = true;\n        }\n      }\n\n      if (!equals && oldProps[key] !== newProps[key]) {\n        return `${triggerName}.${key} changed shallowly: ${oldProps[key]} -> ${newProps[key]}`;\n      }\n    }\n  }\n\n  // Test if any new props have been added\n  for (const key in newProps) {\n    if (!(key in ignoreProps)) {\n      if (!(key in oldProps)) {\n        return `${triggerName}.${key} added: undefined -> ${newProps[key]}`;\n      }\n    }\n  }\n\n  return null;\n}\n/* eslint-enable max-statements, max-depth, complexity */\n\n// HELPERS\n\n// The comparison of the data prop requires special handling\n// the dataComparator should be used if supplied\nfunction diffDataProps(props, oldProps) {\n  if (oldProps === null) {\n    return 'oldProps is null, initial diff';\n  }\n\n  // Support optional app defined comparison of data\n  const {dataComparator} = props;\n  if (dataComparator) {\n    if (!dataComparator(props.data, oldProps.data)) {\n      return 'Data comparator detected a change';\n    }\n    // Otherwise, do a shallow equal on props\n  } else if (props.data !== oldProps.data) {\n    return 'A new data container was supplied';\n  }\n\n  return null;\n}\n\n// Checks if any update triggers have changed\n// also calls callback to invalidate attributes accordingly.\nfunction diffUpdateTriggers(props, oldProps) {\n  if (oldProps === null) {\n    return 'oldProps is null, initial diff';\n  }\n\n  // If the 'all' updateTrigger fires, ignore testing others\n  if ('all' in props.updateTriggers) {\n    const diffReason = diffUpdateTrigger(oldProps, props, 'all');\n    if (diffReason) {\n      return {all: true};\n    }\n  }\n\n  const triggerChanged = {};\n  let reason = false;\n  // If the 'all' updateTrigger didn't fire, need to check all others\n  for (const triggerName in props.updateTriggers) {\n    if (triggerName !== 'all') {\n      const diffReason = diffUpdateTrigger(oldProps, props, triggerName);\n      if (diffReason) {\n        triggerChanged[triggerName] = true;\n        reason = triggerChanged;\n      }\n    }\n  }\n\n  return reason;\n}\n\nfunction diffUpdateTrigger(props, oldProps, triggerName) {\n  const newTriggers = props.updateTriggers[triggerName] || {};\n  const oldTriggers = oldProps.updateTriggers[triggerName] || {};\n  const diffReason = compareProps({\n    oldProps: oldTriggers,\n    newProps: newTriggers,\n    triggerName\n  });\n  return diffReason;\n}\n"],"file":"props.js"}