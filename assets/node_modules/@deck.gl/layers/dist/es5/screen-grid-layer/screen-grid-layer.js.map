{"version":3,"sources":["../../../src/screen-grid-layer/screen-grid-layer.js"],"names":["defaultColorRange","experimental","quantizeScale","DEFAULT_MINCOLOR","DEFAULT_MAXCOLOR","defaultProps","cellSizePixels","colorDomain","colorRange","getPosition","d","position","getWeight","ScreenGridLayer","vs","fs","modules","attributeManager","getAttributeManager","gl","context","addInstanced","instancePositions","size","update","calculateInstancePositions","instanceColors","type","GL","UNSIGNED_BYTE","transition","accessor","calculateInstanceColors","setState","model","_getModel","changeFlags","somethingChanged","oldProps","props","cellSizeChanged","viewportChanged","updateCell","uniforms","parameters","state","cellScale","Object","assign","draw","depthTest","depthMask","Model","getShaders","id","geometry","Geometry","drawMode","TRIANGLE_FAN","attributes","vertices","Float32Array","isInstanced","shaderCache","viewport","width","height","MARGIN","numCol","Math","ceil","numRow","numInstances","invalidateAll","attribute","value","i","x","y","floor","data","weights","Array","maxCount","fill","point","pixel","project","colId","rowId","color","_getColor","index","weight","minColor","maxColor","_shouldUseMinMax","step","Number","isFinite","Layer","layerName"],"mappings":";;;;;;;AAoBA;;AAGA;;AACA;;AACA;;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;IALOA,iB,GAAoCC,kB,CAApCD,iB;IAAmBE,a,GAAiBD,kB,CAAjBC,a;AAM1B,IAAMC,mBAAmB,CAAC,CAAD,EAAI,CAAJ,EAAO,CAAP,EAAU,GAAV,CAAzB;AACA,IAAMC,mBAAmB,CAAC,CAAD,EAAI,GAAJ,EAAS,CAAT,EAAY,GAAZ,CAAzB;AAEA,IAAMC,eAAe;AACnBC,kBAAgB,GADG;AAGnBC,eAAa,IAHM;AAInBC,cAAYR,iBAJO;AAMnBS,eAAa;AAAA,WAAKC,EAAEC,QAAP;AAAA,GANM;AAOnBC,aAAW;AAAA,WAAK,CAAL;AAAA;AAPQ,CAArB;;IAUqBC,e;;;;;;;;;;;;;iCACN;AACX,aAAO;AAACC,0CAAD;AAAKC,4CAAL;AAASC,iBAAS,CAAC,SAAD;AAAlB,OAAP,CADW,CAC4B;AACxC;;;sCAEiB;AAChB,UAAMC,mBAAmB,KAAKC,mBAAL,EAAzB;AADgB,UAETC,EAFS,GAEH,KAAKC,OAFF,CAETD,EAFS;AAIhB;;AACAF,uBAAiBI,YAAjB,CAA8B;AAC5BC,2BAAmB;AAACC,gBAAM,CAAP;AAAUC,kBAAQ,KAAKC;AAAvB,SADS;AAE5BC,wBAAgB;AACdH,gBAAM,CADQ;AAEdI,gBAAMC,SAAGC,aAFK;AAGdC,sBAAY,IAHE;AAIdC,oBAAU,CAAC,aAAD,EAAgB,WAAhB,CAJI;AAKdP,kBAAQ,KAAKQ;AALC;AAFY,OAA9B;AAUA;;AAEA,WAAKC,QAAL,CAAc;AAACC,eAAO,KAAKC,SAAL,CAAehB,EAAf;AAAR,OAAd;AACD;;;4CAEgC;AAAA,UAAdiB,WAAc,QAAdA,WAAc;AAC/B,aAAOA,YAAYC,gBAAnB;AACD;;;uCAE2C;AAAA,UAA/BC,QAA+B,SAA/BA,QAA+B;AAAA,UAArBC,KAAqB,SAArBA,KAAqB;AAAA,UAAdH,WAAc,SAAdA,WAAc;;AAC1C,oIAAkB;AAACG,oBAAD;AAAQD,0BAAR;AAAkBF;AAAlB,OAAlB;;AACA,UAAMI,kBAAkBD,MAAMjC,cAAN,KAAyBgC,SAAShC,cAA1D;;AAEA,UAAIkC,mBAAmBJ,YAAYK,eAAnC,EAAoD;AAClD,aAAKC,UAAL;AACD;AACF;;;gCAEgB;AAAA,UAAXC,QAAW,SAAXA,QAAW;AAAA,kCACW,KAAKJ,KADhB,CACRK,UADQ;AAAA,UACRA,UADQ,sCACK,EADL;AAAA,wBAEY,KAAKC,KAFjB;AAAA,UAERX,KAFQ,eAERA,KAFQ;AAAA,UAEDY,SAFC,eAEDA,SAFC;AAGfH,iBAAWI,OAAOC,MAAP,CAAc,EAAd,EAAkBL,QAAlB,EAA4B;AAACG;AAAD,OAA5B,CAAX;AACAZ,YAAMe,IAAN,CAAW;AACTN,0BADS;AAETC,oBAAYG,OAAOC,MAAP,CACV;AACEE,qBAAW,KADb;AAEEC,qBAAW;AAFb,SADU,EAKVP,UALU;AAFH,OAAX;AAUD;;;8BAESzB,E,EAAI;AACZ,aAAO,IAAIiC,WAAJ,CACLjC,EADK,EAEL4B,OAAOC,MAAP,CAAc,EAAd,EAAkB,KAAKK,UAAL,EAAlB,EAAqC;AACnCC,YAAI,KAAKf,KAAL,CAAWe,EADoB;AAEnCC,kBAAU,IAAIC,cAAJ,CAAa;AACrBC,oBAAU7B,SAAG8B,YADQ;AAErBC,sBAAY;AACVC,sBAAU,IAAIC,YAAJ,CAAiB,CAAC,CAAD,EAAI,CAAJ,EAAO,CAAP,EAAU,CAAV,EAAa,CAAb,EAAgB,CAAhB,EAAmB,CAAnB,EAAsB,CAAtB,EAAyB,CAAzB,EAA4B,CAA5B,EAA+B,CAA/B,EAAkC,CAAlC,CAAjB;AADA;AAFS,SAAb,CAFyB;AAQnCC,qBAAa,IARsB;AASnCC,qBAAa,KAAK3C,OAAL,CAAa2C;AATS,OAArC,CAFK,CAAP;AAcD;;;iCAEY;AAAA,kCACa,KAAK3C,OAAL,CAAa4C,QAD1B;AAAA,UACJC,KADI,yBACJA,KADI;AAAA,UACGC,MADH,yBACGA,MADH;AAAA,UAEJ5D,cAFI,GAEc,KAAKiC,KAFnB,CAEJjC,cAFI;AAIX,UAAM6D,SAAS,CAAf;AACA,UAAMrB,YAAY,IAAIe,YAAJ,CAAiB,CACjC,CAACvD,iBAAiB6D,MAAlB,IAA4BF,KAA5B,GAAoC,CADH,EAEjC,EAAE3D,iBAAiB6D,MAAnB,IAA6BD,MAA7B,GAAsC,CAFL,EAGjC,CAHiC,CAAjB,CAAlB;AAKA,UAAME,SAASC,KAAKC,IAAL,CAAUL,QAAQ3D,cAAlB,CAAf;AACA,UAAMiE,SAASF,KAAKC,IAAL,CAAUJ,SAAS5D,cAAnB,CAAf;AAEA,WAAK2B,QAAL,CAAc;AACZa,4BADY;AAEZsB,sBAFY;AAGZG,sBAHY;AAIZC,sBAAcJ,SAASG;AAJX,OAAd;AAOA,UAAMtD,mBAAmB,KAAKC,mBAAL,EAAzB;AACAD,uBAAiBwD,aAAjB;AACD;;;+CAE0BC,S,SAA2B;AAAA,UAAfF,YAAe,SAAfA,YAAe;AAAA,mCAC5B,KAAKpD,OAAL,CAAa4C,QADe;AAAA,UAC7CC,KAD6C,0BAC7CA,KAD6C;AAAA,UACtCC,MADsC,0BACtCA,MADsC;AAAA,UAE7C5D,cAF6C,GAE3B,KAAKiC,KAFsB,CAE7CjC,cAF6C;AAAA,UAG7C8D,MAH6C,GAGnC,KAAKvB,KAH8B,CAG7CuB,MAH6C;AAAA,UAI7CO,KAJ6C,GAI9BD,SAJ8B,CAI7CC,KAJ6C;AAAA,UAItCpD,IAJsC,GAI9BmD,SAJ8B,CAItCnD,IAJsC;;AAMpD,WAAK,IAAIqD,IAAI,CAAb,EAAgBA,IAAIJ,YAApB,EAAkCI,GAAlC,EAAuC;AACrC,YAAMC,IAAID,IAAIR,MAAd;AACA,YAAMU,IAAIT,KAAKU,KAAL,CAAWH,IAAIR,MAAf,CAAV;AACAO,cAAMC,IAAIrD,IAAJ,GAAW,CAAjB,IAAsBsD,IAAIvE,cAAJ,GAAqB2D,KAArB,GAA6B,CAA7B,GAAiC,CAAvD;AACAU,cAAMC,IAAIrD,IAAJ,GAAW,CAAjB,IAAsB,IAAIuD,IAAIxE,cAAJ,GAAqB4D,MAArB,GAA8B,CAAxD;AACAS,cAAMC,IAAIrD,IAAJ,GAAW,CAAjB,IAAsB,CAAtB;AACD;AACF;;;4CAEuBmD,S,EAAW;AAAA,wBACsB,KAAKnC,KAD3B;AAAA,UAC1ByC,IAD0B,eAC1BA,IAD0B;AAAA,UACpB1E,cADoB,eACpBA,cADoB;AAAA,UACJG,WADI,eACJA,WADI;AAAA,UACSG,SADT,eACSA,SADT;AAAA,yBAEM,KAAKiC,KAFX;AAAA,UAE1BuB,MAF0B,gBAE1BA,MAF0B;AAAA,UAElBG,MAFkB,gBAElBA,MAFkB;AAAA,UAEVC,YAFU,gBAEVA,YAFU;AAAA,UAG1BG,KAH0B,GAGXD,SAHW,CAG1BC,KAH0B;AAAA,UAGnBpD,IAHmB,GAGXmD,SAHW,CAGnBnD,IAHmB;AAIjC,UAAM0D,UAAU,IAAIC,KAAJ,CAAUV,YAAV,CAAhB;AACA,UAAIW,WAAW,CAAf;AAEAF,cAAQG,IAAR,CAAa,GAAb,EAPiC,CASjC;;AATiC;AAAA;AAAA;;AAAA;AAUjC,6BAAoBJ,IAApB,8HAA0B;AAAA,cAAfK,KAAe;AACxB,cAAMC,QAAQ,KAAKC,OAAL,CAAa9E,YAAY4E,KAAZ,CAAb,CAAd;AACA,cAAMG,QAAQnB,KAAKU,KAAL,CAAWO,MAAM,CAAN,IAAWhF,cAAtB,CAAd;AACA,cAAMmF,QAAQpB,KAAKU,KAAL,CAAWO,MAAM,CAAN,IAAWhF,cAAtB,CAAd;;AACA,cAAIkF,SAAS,CAAT,IAAcA,QAAQpB,MAAtB,IAAgCqB,SAAS,CAAzC,IAA8CA,QAAQlB,MAA1D,EAAkE;AAChE,gBAAMK,KAAIY,QAAQC,QAAQrB,MAA1B;;AACAa,oBAAQL,EAAR,KAAchE,UAAUyE,KAAV,CAAd;;AACA,gBAAIJ,QAAQL,EAAR,IAAaO,QAAjB,EAA2B;AACzBA,yBAAWF,QAAQL,EAAR,CAAX;AACD;AACF;AACF;AArBgC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAsBjC,WAAK3C,QAAL,CAAc;AAACkD;AAAD,OAAd,EAtBiC,CAwBjC;;AACA,WAAK,IAAIP,IAAI,CAAb,EAAgBA,IAAIJ,YAApB,EAAkCI,GAAlC,EAAuC;AACrC,YAAMc,QAAQ,KAAKC,SAAL,CAAeV,QAAQL,CAAR,CAAf,EAA2BO,QAA3B,CAAd;;AACA,YAAMS,QAAQhB,IAAIrD,IAAlB;AACAoD,cAAMiB,QAAQ,CAAd,IAAmBF,MAAM,CAAN,CAAnB;AACAf,cAAMiB,QAAQ,CAAd,IAAmBF,MAAM,CAAN,CAAnB;AACAf,cAAMiB,QAAQ,CAAd,IAAmBF,MAAM,CAAN,CAAnB;AACAf,cAAMiB,QAAQ,CAAd,IAAmBF,MAAM,CAAN,CAAnB;AACD;AACF;;;8BAESG,M,EAAQV,Q,EAAU;AAC1B,UAAIO,KAAJ;AAD0B,yBAEe,KAAKnD,KAFpB;AAAA,UAEnBuD,QAFmB,gBAEnBA,QAFmB;AAAA,UAETC,QAFS,gBAETA,QAFS;AAAA,UAECvF,UAFD,gBAECA,UAFD;;AAG1B,UAAI,KAAKwF,gBAAL,EAAJ,EAA6B;AAC3B,YAAMC,OAAOJ,SAASV,QAAtB,CAD2B,CAE3B;;AACAO,gBAAQ,gBAAKI,YAAY3F,gBAAjB,EAAmC4F,YAAY3F,gBAA/C,EAAiE6F,IAAjE,CAAR;AACA,eAAOP,KAAP;AACD,OARyB,CAS1B;;;AACA,UAAMnF,cAAc,KAAKgC,KAAL,CAAWhC,WAAX,IAA0B,CAAC,CAAD,EAAI4E,QAAJ,CAA9C;;AACA,UAAIU,SAAStF,YAAY,CAAZ,CAAT,IAA2BsF,SAAStF,YAAY,CAAZ,CAAxC,EAAwD;AACtD;AACA,eAAO,CAAC,CAAD,EAAI,CAAJ,EAAO,CAAP,EAAU,CAAV,CAAP;AACD;;AACDmF,cAAQxF,cAAcK,WAAd,EAA2BC,UAA3B,EAAuCqF,MAAvC,CAAR,CAf0B,CAgB1B;;AACAH,YAAM,CAAN,IAAWQ,OAAOC,QAAP,CAAgBT,MAAM,CAAN,CAAhB,IAA4BA,MAAM,CAAN,CAA5B,GAAuC,GAAlD;AACA,aAAOA,KAAP;AACD;;;uCAEkB;AAAA,yBACqC,KAAKnD,KAD1C;AAAA,UACVuD,QADU,gBACVA,QADU;AAAA,UACAC,QADA,gBACAA,QADA;AAAA,UACUxF,WADV,gBACUA,WADV;AAAA,UACuBC,UADvB,gBACuBA,UADvB;;AAEjB,UAAIsF,YAAYC,QAAhB,EAA0B;AACxB,eAAO,IAAP;AACD,OAJgB,CAKjB;AACA;;;AACA,UAAIxF,eAAeC,UAAnB,EAA+B;AAC7B,eAAO,KAAP;AACD,OATgB,CAUjB;;;AACA,aAAO,IAAP;AACD;;;;EAlL0C4F,W;;;AAqL7CvF,gBAAgBwF,SAAhB,GAA4B,iBAA5B;AACAxF,gBAAgBR,YAAhB,GAA+BA,YAA/B","sourcesContent":["// Copyright (c) 2015 - 2017 Uber Technologies, Inc.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\n\nimport {Layer, experimental} from '@deck.gl/core';\nconst {defaultColorRange, quantizeScale} = experimental;\n\nimport {GL, Model, Geometry} from 'luma.gl';\nimport {lerp} from 'math.gl';\nimport vs from './screen-grid-layer-vertex.glsl';\nimport fs from './screen-grid-layer-fragment.glsl';\nconst DEFAULT_MINCOLOR = [0, 0, 0, 255];\nconst DEFAULT_MAXCOLOR = [0, 255, 0, 255];\n\nconst defaultProps = {\n  cellSizePixels: 100,\n\n  colorDomain: null,\n  colorRange: defaultColorRange,\n\n  getPosition: d => d.position,\n  getWeight: d => 1\n};\n\nexport default class ScreenGridLayer extends Layer {\n  getShaders() {\n    return {vs, fs, modules: ['picking']}; // 'project' module added by default.\n  }\n\n  initializeState() {\n    const attributeManager = this.getAttributeManager();\n    const {gl} = this.context;\n\n    /* eslint-disable max-len */\n    attributeManager.addInstanced({\n      instancePositions: {size: 3, update: this.calculateInstancePositions},\n      instanceColors: {\n        size: 4,\n        type: GL.UNSIGNED_BYTE,\n        transition: true,\n        accessor: ['getPosition', 'getWeight'],\n        update: this.calculateInstanceColors\n      }\n    });\n    /* eslint-disable max-len */\n\n    this.setState({model: this._getModel(gl)});\n  }\n\n  shouldUpdateState({changeFlags}) {\n    return changeFlags.somethingChanged;\n  }\n\n  updateState({oldProps, props, changeFlags}) {\n    super.updateState({props, oldProps, changeFlags});\n    const cellSizeChanged = props.cellSizePixels !== oldProps.cellSizePixels;\n\n    if (cellSizeChanged || changeFlags.viewportChanged) {\n      this.updateCell();\n    }\n  }\n\n  draw({uniforms}) {\n    const {parameters = {}} = this.props;\n    const {model, cellScale} = this.state;\n    uniforms = Object.assign({}, uniforms, {cellScale});\n    model.draw({\n      uniforms,\n      parameters: Object.assign(\n        {\n          depthTest: false,\n          depthMask: false\n        },\n        parameters\n      )\n    });\n  }\n\n  _getModel(gl) {\n    return new Model(\n      gl,\n      Object.assign({}, this.getShaders(), {\n        id: this.props.id,\n        geometry: new Geometry({\n          drawMode: GL.TRIANGLE_FAN,\n          attributes: {\n            vertices: new Float32Array([0, 0, 0, 1, 0, 0, 1, 1, 0, 0, 1, 0])\n          }\n        }),\n        isInstanced: true,\n        shaderCache: this.context.shaderCache\n      })\n    );\n  }\n\n  updateCell() {\n    const {width, height} = this.context.viewport;\n    const {cellSizePixels} = this.props;\n\n    const MARGIN = 2;\n    const cellScale = new Float32Array([\n      (cellSizePixels - MARGIN) / width * 2,\n      -(cellSizePixels - MARGIN) / height * 2,\n      1\n    ]);\n    const numCol = Math.ceil(width / cellSizePixels);\n    const numRow = Math.ceil(height / cellSizePixels);\n\n    this.setState({\n      cellScale,\n      numCol,\n      numRow,\n      numInstances: numCol * numRow\n    });\n\n    const attributeManager = this.getAttributeManager();\n    attributeManager.invalidateAll();\n  }\n\n  calculateInstancePositions(attribute, {numInstances}) {\n    const {width, height} = this.context.viewport;\n    const {cellSizePixels} = this.props;\n    const {numCol} = this.state;\n    const {value, size} = attribute;\n\n    for (let i = 0; i < numInstances; i++) {\n      const x = i % numCol;\n      const y = Math.floor(i / numCol);\n      value[i * size + 0] = x * cellSizePixels / width * 2 - 1;\n      value[i * size + 1] = 1 - y * cellSizePixels / height * 2;\n      value[i * size + 2] = 0;\n    }\n  }\n\n  calculateInstanceColors(attribute) {\n    const {data, cellSizePixels, getPosition, getWeight} = this.props;\n    const {numCol, numRow, numInstances} = this.state;\n    const {value, size} = attribute;\n    const weights = new Array(numInstances);\n    let maxCount = 0;\n\n    weights.fill(0.0);\n\n    // aggregate weights\n    for (const point of data) {\n      const pixel = this.project(getPosition(point));\n      const colId = Math.floor(pixel[0] / cellSizePixels);\n      const rowId = Math.floor(pixel[1] / cellSizePixels);\n      if (colId >= 0 && colId < numCol && rowId >= 0 && rowId < numRow) {\n        const i = colId + rowId * numCol;\n        weights[i] += getWeight(point);\n        if (weights[i] > maxCount) {\n          maxCount = weights[i];\n        }\n      }\n    }\n    this.setState({maxCount});\n\n    // Convert weights to colors.\n    for (let i = 0; i < numInstances; i++) {\n      const color = this._getColor(weights[i], maxCount);\n      const index = i * size;\n      value[index + 0] = color[0];\n      value[index + 1] = color[1];\n      value[index + 2] = color[2];\n      value[index + 3] = color[3];\n    }\n  }\n\n  _getColor(weight, maxCount) {\n    let color;\n    const {minColor, maxColor, colorRange} = this.props;\n    if (this._shouldUseMinMax()) {\n      const step = weight / maxCount;\n      // We are supporting optional props as deprecated, set default value if not provided\n      color = lerp(minColor || DEFAULT_MINCOLOR, maxColor || DEFAULT_MAXCOLOR, step);\n      return color;\n    }\n    // if colorDomain not set , use default domain [1, maxCount]\n    const colorDomain = this.props.colorDomain || [1, maxCount];\n    if (weight < colorDomain[0] || weight > colorDomain[1]) {\n      // wight outside the domain, set color alpha to 0.\n      return [0, 0, 0, 0];\n    }\n    color = quantizeScale(colorDomain, colorRange, weight);\n    // add alpha to color if not defined in colorRange\n    color[3] = Number.isFinite(color[3]) ? color[3] : 255;\n    return color;\n  }\n\n  _shouldUseMinMax() {\n    const {minColor, maxColor, colorDomain, colorRange} = this.props;\n    if (minColor || maxColor) {\n      return true;\n    }\n    // minColor and maxColor not supplied, check if colorRange or colorDomain supplied.\n    // NOTE: colorDomain and colorRange are experimental features, use them only when supplied.\n    if (colorDomain || colorRange) {\n      return false;\n    }\n    // None specified, use default minColor and maxColor\n    return true;\n  }\n}\n\nScreenGridLayer.layerName = 'ScreenGridLayer';\nScreenGridLayer.defaultProps = defaultProps;\n"],"file":"screen-grid-layer.js"}