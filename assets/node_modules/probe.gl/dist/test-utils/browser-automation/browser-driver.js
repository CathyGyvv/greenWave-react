'use strict';Object.defineProperty(exports,'__esModule',{value:!0});var _createClass=function(){function defineProperties(target,props){for(var descriptor,i=0;i<props.length;i++)descriptor=props[i],descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,'value'in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),_color=require('../../lib/utils/color'),_log=require('../../lib/log'),_log2=_interopRequireDefault(_log);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _toConsumableArray(arr){if(Array.isArray(arr)){for(var i=0,arr2=Array(arr.length);i<arr.length;i++)arr2[i]=arr[i];return arr2}return Array.from(arr)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError('Cannot call a class as a function')}var log=new _log2.default({id:'render-test'}),DEFAULT_CONFIG={process:'./node_modules/.bin/webpack-dev-server',parameters:['--config','webpack.config.js'],port:5e3,options:{maxBuffer:5120000}},DEFAULT_PUPPETEER_OPTIONS={headless:!1},BrowserDriver=function(){function BrowserDriver(){_classCallCheck(this,BrowserDriver),this.execFile=module.require('child_process').execFile,this.puppeteer=module.require('puppeteer'),this.console=module.require('console'),this.process=module.require('process'),this.child=null,this.browser=null,this.page=null,this.port=null,this.shellStatus=0}return _createClass(BrowserDriver,[{key:'setShellStatus',value:function setShellStatus(success){this.shellStatus=success?0:1}},{key:'startBrowser',value:function startBrowser(){var _this=this,options=0<arguments.length&&void 0!==arguments[0]?arguments[0]:DEFAULT_PUPPETEER_OPTIONS;return this.browser?Promise.resolve(this.browser):this.puppeteer.launch(options).then(function(browser){_this.browser=browser})}},{key:'newPage',value:function newPage(){var _this2=this,_ref=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},_ref$url=_ref.url,url=void 0===_ref$url?'http://localhost':_ref$url,_ref$width=_ref.width,width=void 0===_ref$width?1550:_ref$width,_ref$height=_ref.height,height=void 0===_ref$height?850:_ref$height;return log.log({message:'Connecting to port: '+this.port,color:_color.COLOR.YELLOW})(),this.startBrowser().then(function(){return _this2.browser.newPage()}).then(function(page){_this2.page=page}).then(function(){return _this2.page.waitFor(1e3)}).then(function(){return _this2.page.goto(url+':'+_this2.port)}).then(function(){return _this2.page.setViewport({width:1550,height:850})})}},{key:'exposeFunction',value:function exposeFunction(){var _this3=this,name=0<arguments.length&&void 0!==arguments[0]?arguments[0]:'testDriverDone';return new Promise(function(resolve){_this3.page.exposeFunction(name,resolve)})}},{key:'stopBrowser',value:function stopBrowser(){var _this4=this;return Promise.resolve().then(function(){return _this4.page.waitFor(1e3)}).then(function(){return _this4.browser.close()})}},{key:'startServer',value:function startServer(){var _this5=this,config=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},maxRetryTimes=1<arguments.length&&void 0!==arguments[1]?arguments[1]:30,newConfig=Object.assign({},DEFAULT_CONFIG,config);return new Promise(function(resolve,reject){log.log({message:'Binding to port: '+newConfig.port,color:_color.COLOR.YELLOW})();var timeout=setTimeout(function(){resolve()},2e3);_this5.child=_this5.execFile(newConfig.process,[].concat(_toConsumableArray(newConfig.parameters),['--port',''+newConfig.port]),newConfig.options,function(error){error&&(clearTimeout(timeout),log.log({message:'Failed to bind port: '+newConfig.port,color:_color.COLOR.YELLOW})(),reject(error))})}).then(function(){_this5.port=newConfig.port}).catch(function(error){if(0<maxRetryTimes)return newConfig.port++,_this5.startServer(newConfig,maxRetryTimes-1);throw log.log({message:'Failed to start server, use \'killall node\' to stop existing services',color:_color.COLOR.RED})(),error})}},{key:'stopServer',value:function stopServer(){this.child&&(this.child.kill(),this.child=null)}},{key:'exitProcess',value:function exitProcess(){this.process.exit(this.shellStatus)}},{key:'exit',value:function exit(){var _this6=this;return Promise.resolve().then(function(){return _this6.stopBrowser()}).then(function(){_this6.stopServer(),_this6.exitProcess()})}}]),BrowserDriver}();exports.default=BrowserDriver;
//# sourceMappingURL=browser-driver.js.map